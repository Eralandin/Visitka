@model IEnumerable<Visitka.Models.Price>

<link rel="stylesheet" href="~/css/layout/contactform.css" asp-append-version="true" />

<div class="container contactform-container">
    <div class="row first-row">
        <div class="form-text-container col-5">
            <p class="ft1">
                <span class="asterisk">*</span>Оставьте свои контакты<br />
                и информацию для<br />
                обратной связи.
            </p>
            <p class="ft2">
                В ближайшее время с вами<br />
                свяжутся для уточнения<br />
                деталей задачи
            </p>
        </div>
        <div class="form-container col-7">
            <form>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <input type="text" class="form-name" id="name" placeholder="Ваше имя" required>
                    </div>
                    <div class="col-md-6 mb-4">
                        <input type="tel" class="form-phone" id="phone" name="phone" 
                            placeholder="Телефон" 
                            pattern="[\+]?[7-8]?[0-9\s\-\(\)]{10,15}"
                            title="Введите корректный номер телефона (например: +7 999 123-45-67 или 89991234567)"
                            required>
                        <div class="invalid-feedback">
                            Пожалуйста, введите корректный номер телефона
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <input type="email" class="form-email" id="email" placeholder="E-mail" required>
                    </div>
                    <div class="col-md-6 mb-4">
                        <input type="text" class="form-telegram" id="telegram" placeholder="Telegram" required>
                    </div>
                </div>
                <div class="row">
                    <div class="select mb-4">
                        <div class="selectWrapper">
                            <div class="selectCustom js-selectCustom">
                                <div class="selectCustom-trigger" id="selectTrigger" data-selected-value="@ViewData["SelectedServiceId"]">
                                    @if (ViewData["SelectedServiceName"] != null)
                                    {
                                        @ViewData["SelectedServiceName"]
                                    }
                                    else
                                    {
                                        @:Выберите спектр услуг
                                    }
                                </div>
                                <div class="selectCustom-options">
                                    @if (Model != null)
                                    {
                                        foreach (var price in Model)
                                        {
                                            <div class="selectCustom-option" data-value="@price.Id">
                                                @price.Name
                                            </div>
                                        }
                                    }
                                </div>
                                <input type="hidden" id="selectedService" name="selectedServiceId" value="@ViewData["SelectedServiceId"]">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="mb-4">
                        <input type="text" class="contactform-text" id="text" placeholder="Опишите ваш бизнес в двух словах" value="@ViewData["InitialQuestion"]" required>
                    </div>
                </div>
                <div class="row">
                    <div class="mb-4 checkbox-btn">
                        <input type="checkbox" class="contactform-checkbox" id="checkbox" required>
                        <label class="form-checkbox-label" for="checkbox">
                            Согласен с условиями <a class="privacy-checkbox-link" asp-area="" asp-controller="Home" asp-action="Privacy">политики конфиденциальности</a>
                        </label>
                    </div>
                </div>
                <div class="row">
                    <button type="submit" class="submit-btn full-width-btn">Отправить</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const elSelectCustom = document.getElementsByClassName("js-selectCustom")[0];
        const elSelectCustomValue = elSelectCustom.children[0];
        const elSelectCustomOptions = elSelectCustom.children[1];
        const defaultLabel = elSelectCustomValue.getAttribute("data-value");
        const selectedServiceInput = document.getElementById("selectedService");
        
        // Функция для выбора опции
        function selectOption(elOption) {
            const value = elOption.getAttribute("data-value");
            const text = elOption.textContent;
            
            // Обновляем текст триггера
            elSelectCustomValue.textContent = text;
            elSelectCustomValue.setAttribute("data-value", value);
            
            // Обновляем скрытое поле формы
            if (selectedServiceInput) {
                selectedServiceInput.value = value;
            }
            
            // Добавляем стили для выбранного значения
            elSelectCustomValue.classList.add('has-value');
            elSelectCustomValue.style.color = "#ffffff";
            
            // Снимаем выделение со всех опций и добавляем текущей
            Array.from(elSelectCustomOptions.children).forEach(option => {
                option.classList.remove("isActive");
            });
            elOption.classList.add("isActive");
            
            // Закрываем dropdown
            elSelectCustom.classList.remove("isActive");
        }

        // Автоматически выбираем опцию если передан serviceId
        const selectedServiceId = '@ViewData["SelectedServiceId"]';
        if (selectedServiceId) {
            const targetOption = Array.from(elSelectCustomOptions.children).find(option => 
                option.getAttribute("data-value") === selectedServiceId
            );
            
            if (targetOption) {
                selectOption(targetOption);
            }
        }

        // Обработчики кликов по опциям
        Array.from(elSelectCustomOptions.children).forEach(function (elOption) {
            elOption.addEventListener("click", (e) => {
                e.stopPropagation();
                selectOption(elOption);
            });
        });

        // Открытие/закрытие dropdown
        elSelectCustomValue.addEventListener("click", (e) => {
            e.stopPropagation();
            elSelectCustom.classList.toggle("isActive");
        });

        // Закрытие при клике вне элемента
        document.addEventListener("click", (e) => {
            const didClickedOutside = !elSelectCustom.contains(e.target);
            if (didClickedOutside) {
                elSelectCustom.classList.remove("isActive");
            }
        });

        // Закрытие по ESC
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && elSelectCustom.classList.contains("isActive")) {
                elSelectCustom.classList.remove("isActive");
            }
        });

        // Добавляем обработчик для обновления скрытого поля при изменении выбора
        elSelectCustomValue.addEventListener('DOMSubtreeModified', function() {
            if (selectedServiceInput) {
                const currentValue = elSelectCustomValue.getAttribute("data-value");
                if (currentValue && currentValue !== defaultLabel) {
                    selectedServiceInput.value = currentValue;
                }
            }
        });
    });
</script>